@model IEnumerable<WebApplication2.Models.Product>

@{
    ViewData["Title"] = "Каталог товарів";

    var categories = ViewBag.Categories as List<Category>;
    var subcategories = ViewBag.Subcategories as List<Subcategory>;
    var selectedCategory = ViewBag.SelectedCategory as int?;
    var selectedSubcategory = ViewBag.SelectedSubcategory as int?;
    var searchTerm = ViewBag.SearchTerm as string;
}

<h2 class="mb-4 display-6 fw-bold text-center">@ViewData["Title"]</h2>

<form method="get" asp-action="Index" asp-controller="Product" class="row g-3 align-items-end mb-5">
    <div class="col-md-3">
        <label for="searchInput" class="form-label">Пошук</label>
        <input type="text" id="searchInput" name="search" class="form-control"
               value="@searchTerm" placeholder="Пошук товарів..." />
    </div>

    <div class="col-md-3">
        <label for="categorySelect" class="form-label">Категорія</label>
        <select id="category-select" name="category" class="form-select">
            <option value="">Всі категорії</option>
            @foreach (var category in categories)
            {
                <option value="@category.Id" selected="@(selectedCategory == category.Id ? "selected" : null)">
                    @category.Name
                </option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label for="subcategorySelect" class="form-label">Підкатегорія</label>
        <select id="subcategory-select" name="subcategory" class="form-select">
            <option value="">Всі підкатегорії</option>
            @foreach (var subcategory in subcategories)
            {
                <option value="@subcategory.Id" selected="@(selectedSubcategory == subcategory.Id ? "selected" : null)">
                    @subcategory.Name
                </option>
            }
        </select>
    </div>

    <div class="col-md-3">
        <label for="sort-select" class="form-label">Сортування</label>
        <select id="sort-select" name="sortOrder" class="form-select">
            <option value="" selected="@(ViewBag.SortOrder == null ? "selected" : null)">Без сортування</option>
            <option value="price_asc" selected="@(ViewBag.SortOrder == "price_asc" ? "selected" : null)">Від дешевих до дорогих</option>
            <option value="price_desc" selected="@(ViewBag.SortOrder == "price_desc" ? "selected" : null)">Від дорогих до дешевих</option>
        </select>
    </div>
    <div class="col-12 text-end">
        <button type="submit" class="btn btn-cozy d-inline-flex align-items-center gap-2 px-4 py-2" style="line-height: 1; height: 38px;">
             <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="display: block;">
                 <circle cx="11" cy="11" r="7" stroke-linecap="round" stroke-linejoin="round" />
                 <line x1="16.5" y1="16.5" x2="21" y2="21" stroke-linecap="round" stroke-linejoin="round" />
             </svg>
            <span style="line-height: 1; display: flex; align-items: center; margin-left: -4px;">Пошук</span>
        </button>

    
    </div>





</form>



<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
    @foreach (var item in Model)
    {
        <div class="col">
            <div class="card h-100 d-flex flex-column shadow-sm rounded-4 border-0">
                <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id">
                    <img src="@item.ImageUrl" class="card-img-top rounded-top-4" alt="@item.Name"
                         style="height: 200px; object-fit: cover;" />
                </a>

                <div class="card-body d-flex flex-column">
                    <h5 class="card-title fs-5 fw-semibold">
                        <a asp-controller="Product" asp-action="Details" asp-route-id="@item.Id"
                           class="text-decoration-none text-dark">
                            @item.Name
                        </a>
                    </h5>

                    <p class="text-muted mb-1">
                        <small>
                            Категорія: @item.Category?.Name <br />
                            Підкатегорії:
                            @string.Join(", ", item.ProductSubcategories.Select(ps => ps.Subcategory.Name))
                        </small>
                    </p>

                    <p class="card-text text-truncate">
                        @item.Description
                    </p>

                </div>

                <div class="card-footer border-0 mt-auto pt-2 d-flex flex-column align-items-start" style="background-color: transparent;">
                    @{
    var discount = item.Discounts?.FirstOrDefault();
    var hasDiscount = discount != null;
    var finalPrice = hasDiscount ? item.Price * (1 - discount.Percent / 100) : item.Price;
}

@if (hasDiscount)
{
    <div class="mb-1">
        <span class="badge discount-badge mb-1">-@discount.Percent.ToString("0")%</span><br />
        <span class="text-muted price-old">@item.Price.ToString("0.00") грн</span>
        <strong class="fs-5 price-new">@finalPrice.ToString("0.00") грн</strong>
    </div>
}
else
{
    <strong class="fs-5 price-new-only">@item.Price.ToString("0.00") грн</strong>
}



                    @if (item.IsAvailable)
                    {
                        <button class="btn btn-sm mt-2 w-100 d-flex align-items-center justify-content-center gap-1 btn-add-to-cart" data-product-id="@item.Id">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="#fff" stroke-width="1.8" style="vertical-align: middle; margin: 0; transform: translateY(2px);">
                                 <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.6 3m0 0L7 13h10l1.4-7H6.6zM7 13a2 2 0 1 0 0 4 2 2 0 0 0 0-4zm10 0a2 2 0 1 0 0 4 2 2 0 0 0 0-4z"/>
                            </svg>
                           <span>Додати в кошик</span>
                        </button>

                    }
                    else
                    {
                        <button class="btn btn-sm btn-outline-secondary mt-2 w-100" disabled>
                            Немає в наявності
                        </button>
                    }
                </div>
            </div>
        </div>
    }
</div>

<!-- TOAST-КОНТЕЙНЕР -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="toast-cart-added" class="toast align-items-center text-bg-success border-0" role="alert"
         aria-live="assertive" aria-atomic="true" style="display: none;">
        <div class="d-flex">
            <div class="toast-body">
                ✅ Товар додано до кошика
            </div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Закрити"></button>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Завантаження підкатегорій при зміні категорії
        document.getElementById('category-select').addEventListener('change', function () {
            const categoryId = this.value;
            const subcategorySelect = document.getElementById('subcategory-select');

            if (!categoryId) {
                subcategorySelect.innerHTML = '<option value="">Всі підкатегорії</option>';
                return;
            }

            fetch(`/Product/GetSubcategoriesByCategory?categoryId=${categoryId}`)
                .then(response => response.json())
                .then(data => {
                    subcategorySelect.innerHTML = '<option value="">Всі підкатегорії</option>';
                    data.forEach(sub => {
                        const option = document.createElement('option');
                        option.value = sub.id;
                        option.textContent = sub.name;
                        subcategorySelect.appendChild(option);
                    });
                })
                .catch(error => console.error('Помилка при завантаженні підкатегорій:', error));
        });

        // Додавання в кошик
        document.addEventListener('DOMContentLoaded', function () {
            const token = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

            document.body.addEventListener('click', function (e) {
                const btn = e.target.closest('.btn-add-to-cart');
                if (btn && !btn.classList.contains('disabled')) {
                    e.preventDefault();

                    const productId = btn.getAttribute('data-product-id');
                    const url = `/Cart/AddToCart/${productId}`;

                    fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'RequestVerificationToken': token
                        },
                        body: null
                    })
                        .then(response => response.ok ? response.json() : Promise.reject())
                        .then(data => {
                            if (data.success) {
                                const cartCountEl = document.getElementById('cart-count');
                                if (cartCountEl) {
                                    cartCountEl.textContent = data.totalItems;
                                    cartCountEl.style.display = data.totalItems > 0 ? 'inline-block' : 'none';
                                }

                                // ✅ Зміна вигляду кнопки — кастомний клас і блокування
                                btn.classList.remove('btn-primary', 'btn-outline-secondary');
                                btn.classList.add('added-to-cart');
                                btn.disabled = true;
                                btn.innerHTML = `
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="#fff" stroke-width="3" style="vertical-align: middle; margin-right: 6px;">
        <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/>
    </svg>
    Додано
`;


                                showCartToast();
                            } else {
                                alert('Не вдалося додати товар у кошик.');
                            }
                        })
                        .catch(() => alert('Не вдалося додати товар у кошик.'));
                }
            });

            function showCartToast() {
                const toastEl = document.getElementById('toast-cart-added');
                if (toastEl) {
                    toastEl.style.display = 'block';
                    const toast = new bootstrap.Toast(toastEl, { delay: 3000 });
                    toast.show();
                }
            }
        });
    </script>
}



